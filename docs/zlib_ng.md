
# Thoughts on supporting zlib-ng

## Compression with zlib-ng

zlib-ng is a 3rd zlib implemention. It's compatible with zlib v1.2.11. In order to support multi-architecture platforms, zlib-ng provides the hooks in below.

```
    #define ZALLOC_STATE(strm, items, size) ...
    #define ZFREE_STATE(strm, addr) ...
    #define ZCOPY_STATE(dst, src, size) ...
    #define ZALLOC_WINDOW(strm, items, size) ...
    #define TRY_FREE_WINDOW(strm, addr) ...
    #define DEFLATE_SET_DICTIONARY_HOOK(strm, dict, dict_len) ...
    #define DEFLATE_GET_DICTIONARY_HOOK(strm, dict, dict_len) ...
    #define DEFLATE_RESET_KEEP_HOOK(strm) ...
    #define DEFLATE_END_HOOK(strm) ...
    #define DEFLATE_PARAMS_HOOK(strm, level, strategy) ...
    #define DEFLATE_BOUND_ADJUST_COMPLEN(strm, complen, sourcelen) ...
    #define DEFLATE_NEED_CONSERVATIVE_BOUND(strm) ...
    #define DEFLATE_HOOK(strm, flush, bstate) ...
    #define DEFLATE_NEED_CHECKSUM(strm) ...
    #define DEFLATE_CAN_SET_REPRODUCIBLE(strm, reproducible) ...
```

Based on current hardware implementation, we could define the warpdrive interfaces for integrating zlib-ng.

***void \*wdzlib_alloc_state(streamp strm, unsigned int items, unsigned int size);***

***void wdzlib_copy_state(void \*dst, const void \*src, unsigned int size);***

***int wdzlib_can_deflate(streamp strm);***

***void wdzlib_deflate_reset(streamp strm, unsigned int size);***

***int wdzlib_deflate_params(streamp strm, int level, int strategy);***

***int wdzlib_deflate(streamp strm, int flush, block_state \*result);***

All these APIs should be implemented in warpdrive. We only reference these APIs in zlib-ng.


### Decompression with zlib-ng

zlib-ng provides the hooks in below.

```
    #define ZALLOC_STATE(strm, items, size) ...
    #define ZFREE_STATE(strm, addr) ...
    #define ZCOPY_STATE(dst, src, size) ...
    #define ZALLOC_WINDOW(strm, items, size) ...
    #define ZFREE_WINDOW(strm, addr) ...
    #define INFLATE_RESET_KEEP_HOOK(strm) ...
    #define INFLATE_PRIME_HOOK(strm, bits, value) ...
    #define INFLATE_TYPEDO_HOOK(strm, flush) ...
    #define INFLATE_NEED_CHECKSUM(strm) ...
    #define INFLATE_NEED_UPDATEWINDOW(strm) ...
    #define INFLATE_MARK_HOOK(strm) ...
```

Based on current hardware implementation, we define the warpdrive interfaces for integrating zlib-ng.

***void \*wdzlib_alloc_state(streamp strm, unsigned int items, unsigned int size);***

***void wdzlib_copy_state(void \*dst, const void \*src, unsigned int size);***

***int wdzlib_can_inflate(streamp strm);***

***void wdzlib_inflate_reset(streamp strm, unsigned int size);***

***wd_inflate_action wdzlib_inflate(streamp strm, int flush, int \*ret);***

